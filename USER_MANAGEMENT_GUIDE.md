# 用户管理和历史订单功能使用指南

## 功能概述

已成功为宝得利门窗订购网站添加了以下两个核心功能模块：

### 🔧 1. 后台用户管理模块
- **用户列表管理**：查看所有注册用户信息
- **用户状态管理**：启用/禁用用户账户
- **用户详情查看**：查看用户完整信息和订单历史
- **用户搜索**：支持按姓名、手机号搜索
- **统计信息**：显示用户总数、活跃用户数等

### 👤 2. 用户端历史订单模块
- **订单历史查看**：用户查看自己的所有订单
- **订单筛选**：按状态筛选订单
- **订单详情**：查看订单完整信息
- **用户认证**：与用户登录系统集成
- **订单关联**：新订单自动关联到登录用户

## 技术实现

### 数据库模型

#### 新增User模型
```javascript
// server/models/sequelize/User.js
- id: 用户唯一标识
- phone: 手机号（唯一）
- name: 用户姓名
- wechatId: 微信号
- district: 所在区域
- address: 详细地址
- email: 邮箱地址
- status: 用户状态（active/inactive/banned）
- lastLoginAt: 最后登录时间
- totalOrders: 总订单数
- totalAmount: 总消费金额
```

#### 更新Order模型
```javascript
// 添加userId字段关联用户
userId: {
  type: DataTypes.INTEGER,
  allowNull: true,
  comment: '用户ID'
}

// 建立关联关系
User.hasMany(Order, { foreignKey: 'userId', as: 'orders' });
Order.belongsTo(User, { foreignKey: 'userId', as: 'user' });
```

### API接口

#### 用户相关API（/api/users）
- `POST /register` - 用户注册
- `POST /login` - 用户登录
- `GET /profile` - 获取用户信息
- `PUT /profile` - 更新用户信息
- `GET /orders` - 获取用户订单历史
- `GET /orders/:id` - 获取订单详情

#### 管理员用户管理API（/api/admin/users）
- `GET /` - 获取用户列表（支持分页、搜索、筛选）
- `GET /:id` - 获取用户详情
- `PUT /:id/status` - 更新用户状态
- `PUT /:id` - 更新用户信息
- `DELETE /:id` - 删除用户

### 前端页面

#### 后台管理页面
- **UserAdmin.vue** - 用户管理主页面
  - 路由：`/admin/users`
  - 功能：用户列表、搜索、状态管理、用户详情
  - 集成到AdminHome.vue中

#### 用户端页面
- **UserOrders.vue** - 用户订单历史页面
  - 路由：`/orders`
  - 功能：订单列表、筛选、详情查看
  - 在Header组件中添加入口

## 使用说明

### 启动系统

1. **启动后端服务**
```bash
cd server
npm install
npm run dev
```

2. **启动前端服务**
```bash
cd client
npm install
npm run dev
```

### 后台用户管理

1. **访问管理后台**
   - 访问：`http://localhost:5173/admin/login`
   - 账号：`admin`
   - 密码：`123456`

2. **进入用户管理**
   - 登录后点击"用户管理"卡片
   - 或直接访问：`http://localhost:5173/admin/users`

3. **功能操作**
   - **查看用户列表**：显示所有注册用户
   - **搜索用户**：在搜索框输入姓名或手机号
   - **筛选状态**：选择用户状态进行筛选
   - **查看详情**：点击👁️按钮查看用户详细信息
   - **管理状态**：点击✓/✗按钮启用/禁用用户

### 用户端订单历史

1. **用户注册/登录**
   - 新用户：访问 `/register` 注册账户
   - 老用户：访问 `/login` 登录

2. **查看订单历史**
   - **桌面端**：点击右上角用户头像 → "我的订单"
   - **移动端**：点击菜单 → "我的订单"
   - **直接访问**：`http://localhost:5173/orders`

3. **订单功能**
   - **筛选订单**：按状态筛选（待联系、已联系、已完成、已取消）
   - **查看详情**：点击订单卡片查看详细信息
   - **空状态处理**：未登录时引导登录，无订单时引导购买

### 订单关联功能

1. **自动关联**
   - 用户登录后下单，订单自动关联到用户账户
   - 用户统计信息自动更新（订单数、消费金额）

2. **数据统计**
   - 后台首页显示用户统计信息
   - 用户详情页显示个人消费统计

## 测试场景

### 场景1：新用户注册下单流程
1. 访问网站首页
2. 点击"注册" → 填写信息 → 验证手机号（123456）
3. 注册成功后自动登录
4. 选择商品 → 加入购物车 → 下单
5. 查看"我的订单"确认订单已关联

### 场景2：管理员用户管理流程
1. 登录管理后台
2. 进入"用户管理"
3. 查看用户列表和统计信息
4. 搜索特定用户
5. 查看用户详情和订单历史
6. 管理用户状态

### 场景3：历史用户数据兼容
- 系统兼容现有订单数据
- 新增userId字段允许为空，保证历史订单正常显示
- 管理员可以看到所有订单（包括未关联用户的订单）

## 数据库初始化

系统启动时会自动创建User表并建立关联关系。如需手动重置：

```bash
cd server
node scripts/initDB.js
```

## 注意事项

1. **开发环境验证码**：固定为`123456`
2. **用户认证**：基于JWT token，有效期7天
3. **数据安全**：管理员功能需要认证，用户只能查看自己的订单
4. **兼容性**：保持与现有系统的完全兼容，不影响未登录用户下单

## 后续扩展建议

1. **短信验证码集成**：接入真实短信服务
2. **用户权限细化**：支持更多用户角色
3. **订单状态推送**：订单状态变更时通知用户
4. **数据分析**：添加更详细的用户行为分析
5. **导出功能**：支持用户数据和订单数据导出

---

✅ **功能已完成，可以正常使用！**

如有问题，请检查：
- 服务器是否正常启动
- 数据库连接是否正常
- 前端路由是否正确配置 